<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RecyGo</title>

<link rel="icon" type="image/png" href="logo.jpg">
  
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f0fff0; }
  img {margin-top: 20px; border-radius: 10px;}
  h1 { color: #2a7a2a; }
  input { padding: 8px; margin: 5px; font-size: 15px; width: 200px; }
  button { margin: 6px; padding: 10px 18px; cursor: pointer; font-size: 16px; border-radius: 8px; }
  .score { font-size: 1.5em; margin-top: 10px; color: green; }
  #webcam-container { margin-top: 10px; }
  #status { margin-top: 10px; font-weight: bold; }
  #detectStatus { margin-top: 12px; font-size: 1.2em; }
</style>
</head>
<body>
  <img src="logo.jpg" alt="RecyGo Logo" width="120">
  
  <h1>♻️ RecyGo </h1>

  <!-- 👩‍🎓 Login -->
  <div id="login-section">
    <h3>👩‍🎓 Enter Your 8-digit Student ID</h3>
    <input id="studentId" type="text" placeholder="e.g. 20250123" maxlength="8" />
    <br>
    <button id="loginBtn">Login / Register</button>
    <p id="error" style="color:red;"></p>
  </div>

  <!-- 🌍 Main Section -->
  <div id="main-section" style="display:none;">
    <p>👤 Logged in as: <span id="userId"></span></p>
    <button id="logoutBtn">Logout</button>
    <hr>
    <button id="connectBtn">🔌 Connect Arduino</button>
    <button id="startBtn">▶️ Start Detection</button>
    <button id="stopBtn">⏹ Stop Detection</button>
    <p id="status">Status: Not connected</p>
    <div id="label">Detected: —</div>
    <div id="detectStatus">💤 Waiting for detection...</div>
    <div class="score">🎁 Points: <span id="points">0</span></div>
    <div id="webcam-container"></div>
  </div>

<script>
/* -------------------- 🔥 Firebase Setup -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAjWXFfQT_5dBtDZvYFwyj4kGfeWQdcCBU",
  authDomain: "recygo-cd169.firebaseapp.com",
  projectId: "recygo-cd169",
  storageBucket: "recygo-cd169.firebasestorage.app",
  messagingSenderId: "965670715995",
  appId: "1:965670715995:web:b4da5995cb0bd5da8c357e",
  measurementId: "G-9MD9PD9PJL"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* -------------------- 🌐 Variables -------------------- */
const URL = "https://teachablemachine.withgoogle.com/models/YSmHvTp9K/";
let model, webcam, port, writer;
let detecting = false;
let rewardPoints = 0;
let currentStudentId = null;
let lastLabel = "", stableCount = 0, lastConfirmedLabel = "";
const STABLE_THRESHOLD = 3;
const detectStatus = document.getElementById("detectStatus");

/* -------------------- 👩‍🎓 Login System -------------------- */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const id = document.getElementById("studentId").value.trim();
  const errorMsg = document.getElementById("error");
  if (!/^\d{8}$/.test(id)) {
    errorMsg.textContent = "⚠️ Please enter a valid 8-digit Student ID";
    return;
  }

  currentStudentId = id;
  errorMsg.textContent = "⏳ Logging in...";
  const docRef = db.collection("students").doc(id);
  const docSnap = await docRef.get();

  if (docSnap.exists) rewardPoints = docSnap.data().points || 0;
  else {
    await docRef.set({ points: 0 });
    rewardPoints = 0;
  }

  document.getElementById("points").innerText = rewardPoints;
  document.getElementById("userId").innerText = id;
  document.getElementById("login-section").style.display = "none";
  document.getElementById("main-section").style.display = "block";
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  currentStudentId = null;
  rewardPoints = 0;
  document.getElementById("login-section").style.display = "block";
  document.getElementById("main-section").style.display = "none";
});

/* -------------------- 🤖 Arduino + AI -------------------- */
document.getElementById("connectBtn").addEventListener("click", async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    document.getElementById("status").innerText = "✅ Arduino Connected";
  } catch (err) {
    alert("❌ Connection failed: " + err);
  }
});

async function init() {
  const modelURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";
  model = await tmImage.load(modelURL, metadataURL);
  const flip = true;
  webcam = new tmImage.Webcam(200, 200, flip);
  await webcam.setup();
  await webcam.play();
  document.getElementById("webcam-container").innerHTML = "";
  document.getElementById("webcam-container").appendChild(webcam.canvas);
}

/* -------------------- 🔁 Detection Loop -------------------- */
async function loop() {
  webcam.update();
  await predict();
  if (detecting) setTimeout(loop, 250);
}

async function predict() {
  const prediction = await model.predict(webcam.canvas);
  let highest = prediction[0];
  for (let p of prediction)
    if (p.probability > highest.probability) highest = p;

  const className = highest.className.trim().toLowerCase();
  const confidence = highest.probability;
  document.getElementById("label").innerText = `Detected: ${className} (${(confidence * 100).toFixed(1)}%)`;

  if (className === lastLabel && confidence > 0.6) stableCount++;
  else { stableCount = 0; lastLabel = className; }

  if (stableCount >= STABLE_THRESHOLD) {
    stableCount = 0;
    handleStableDetection(className);
  }
}

/* -------------------- 🎯 Detection Result -------------------- */
async function handleStableDetection(label) {
  if (label === lastConfirmedLabel) return;
  lastConfirmedLabel = label;

  let msg = "";
  if (label === "recyclable") {
    msg = "RECYCLABLE\n";
    detectStatus.textContent = "✅ Recyclable detected!";
    detectStatus.style.color = "green";
    rewardPoints++;
    document.getElementById("points").innerText = rewardPoints;
    if (currentStudentId)
      await db.collection("students").doc(currentStudentId).update({ points: rewardPoints });
  } 
  else if (label === "non-recyclable") {
    msg = "NONRECYCLABLE\n";
    detectStatus.textContent = "🚫 Non-recyclable detected!";
    detectStatus.style.color = "red";
  }

  if (writer) await writer.write(new TextEncoder().encode(msg));
}

/* -------------------- ▶️ Start / Stop -------------------- */
document.getElementById("startBtn").addEventListener("click", async () => {
  if (!model) await init();
  detecting = true;
  lastConfirmedLabel = "";
  detectStatus.textContent = "🟡 Detecting...";
  detectStatus.style.color = "#555";
  document.getElementById("status").innerText = "🟡 Detection started...";
  if (writer) await writer.write(new TextEncoder().encode("START\n"));
  loop();
});

document.getElementById("stopBtn").addEventListener("click", async () => {
  detecting = false;
  detectStatus.textContent = "💤 Detection stopped.";
  detectStatus.style.color = "#444";
  document.getElementById("status").innerText = "🟠 Detection stopped";
  if (writer) await writer.write(new TextEncoder().encode("STOP\n"));
});
</script>
</body>
</html>






