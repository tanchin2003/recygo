<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RecyGo</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<!-- ✅ Firebase v8 (non-module) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #f0fff0; padding: 25px; }
  h1 { color: #2a7a2a; }
  input { padding: 8px; font-size: 16px; margin: 5px; }
  button { padding: 10px 18px; margin: 5px; font-size: 16px; border-radius: 8px; cursor: pointer; }
  .score { font-size: 1.5em; margin-top: 10px; color: green; transition: transform 0.3s; }
  .flash { transform: scale(1.3); color: limegreen; }
  #webcam-container { margin-top: 10px; }
  #error { color: red; font-weight: bold; }
</style>
</head>
<body>
  <h1>♻️RecyGo</h1>

  <!-- Login Section -->
  <div id="login-section">
    <h3>👩‍🎓 Enter Your 8-digit Student ID</h3>
    <input id="studentId" type="text" maxlength="8" placeholder="e.g. 20250123">
    <br>
    <button id="loginBtn">Login / Register</button>
    <p id="error"></p>
  </div>

  <!-- Main Section -->
  <div id="main-section" style="display:none;">
    <p>👤 Logged in as: <span id="userId"></span></p>
    <button id="logoutBtn">Logout</button>
    <hr>
    <button id="connectBtn">🔌 Connect Arduino</button>
    <button id="startBtn">▶️ Start Detection</button>
    <button id="stopBtn">⏹ Stop Detection</button>
    <p id="status">Status: Not connected</p>
    <div id="label">Detected: —</div>
    <div class="score">🎁 Points: <span id="points">0</span></div>
    <div id="webcam-container"></div>
    <p id="detectionStatus" style="font-size:1.1em; color:#444; margin-top:10px;">
      💤 Waiting for detection...
    </p>
  </div>

<script>
/* -------------------- 🔥 Firebase Setup -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAjWXFfQT_5dBtDZvYFwyj4kGfeWQdcCBU",
  authDomain: "recygo-cd169.firebaseapp.com",
  projectId: "recygo-cd169",
  storageBucket: "recygo-cd169.firebasestorage.app",
  messagingSenderId: "965670715995",
  appId: "1:965670715995:web:b4da5995cb0bd5da8c357e",
  measurementId: "G-9MD9PD9PJL"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* -------------------- 🌐 Global Variables -------------------- */
const URL = "https://teachablemachine.withgoogle.com/models/dImmQ2ojS/";
let model, webcam, port, writer;
let detecting = false;
let rewardPoints = 0;
let currentStudentId = null;
let lastLabel = "", stableCount = 0, lastConfirmedLabel = "";
let lastDetectionTime = 0;
const STABLE_THRESHOLD = 4;
const detectionStatus = document.getElementById("detectionStatus");

/* -------------------- 👤 Login System -------------------- */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const id = document.getElementById("studentId").value.trim();
  const errorMsg = document.getElementById("error");

  if (!/^\d{8}$/.test(id)) {
    errorMsg.textContent = "⚠️ Please enter a valid 8-digit Student ID.";
    return;
  }

  errorMsg.textContent = "⏳ Logging in...";
  const docRef = db.collection("students").doc(id);
  const docSnap = await docRef.get();

  if (docSnap.exists) {
    rewardPoints = docSnap.data().points || 0;
  } else {
    await docRef.set({ points: 0 });
    rewardPoints = 0;
  }

  currentStudentId = id;
  document.getElementById("points").innerText = rewardPoints;
  document.getElementById("userId").innerText = id;
  document.getElementById("login-section").style.display = "none";
  document.getElementById("main-section").style.display = "block";
  errorMsg.textContent = "";
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  currentStudentId = null;
  rewardPoints = 0;
  document.getElementById("login-section").style.display = "block";
  document.getElementById("main-section").style.display = "none";
});

/* -------------------- ⚙️ Arduino + AI -------------------- */
document.getElementById("connectBtn").addEventListener("click", async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    document.getElementById("status").innerText = "✅ Arduino Connected";
  } catch (err) {
    alert("❌ Connection failed: " + err);
  }
});

async function init() {
  const modelURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";
  model = await tmImage.load(modelURL, metadataURL);
  const flip = true;
  webcam = new tmImage.Webcam(200, 200, flip);
  await webcam.setup();
  await webcam.play();
  document.getElementById("webcam-container").innerHTML = "";
  document.getElementById("webcam-container").appendChild(webcam.canvas);
}

async function loop() {
  webcam.update();
  await predict();
  if (detecting) setTimeout(loop, 400);

  // 自動恢復狀態提示
  if (Date.now() - lastDetectionTime > 3000 && detectionStatus.textContent !== "💤 Waiting for detection...") {
    detectionStatus.textContent = "💤 Waiting for detection...";
    detectionStatus.style.color = "#444";
  }
}

/* -------------------- Prediction -------------------- */
async function predict() {
  const prediction = await model.predict(webcam.canvas);
  let highest = prediction[0];
  for (let p of prediction) if (p.probability > highest.probability) highest = p;

  const className = highest.className.trim();
  const confidence = highest.probability;
  document.getElementById("label").innerText = `Detected: ${className} (${(confidence * 100).toFixed(1)}%)`;

  const normalized = className.toLowerCase();
  if (normalized === lastLabel && confidence > 0.55) stableCount++;
  else { stableCount = 0; lastLabel = normalized; }

  if (stableCount >= STABLE_THRESHOLD) {
    stableCount = 0;
    handleStableDetection(normalized);
  }
}

/* -------------------- Detection Handler -------------------- */
async function handleStableDetection(label) {
  const now = Date.now();

  // 若同樣分類在3秒內重複出現 → 不重複觸發
  if (label === lastConfirmedLabel && now - lastDetectionTime < 3000) {
    detectionStatus.textContent = `⚪ Same ${label} detected (ignored within 3s)`;
    detectionStatus.style.color = "#888";
    return;
  }

  // 更新時間與標籤
  lastConfirmedLabel = label;
  lastDetectionTime = now;
  detectionStatus.textContent = `🟢 New ${label} detected!`;
  detectionStatus.style.color = label === "recyclable" ? "green" : "red";

  let msg = "";
  if (label === "recyclable") {
    msg = "RECYCLABLE\n";
    rewardPoints++;
    document.getElementById("points").innerText = rewardPoints;
    document.getElementById("points").classList.add("flash");
    setTimeout(() => document.getElementById("points").classList.remove("flash"), 300);
    if (currentStudentId)
      await db.collection("students").doc(currentStudentId).update({ points: rewardPoints });
  } 
  else if (label === "non-recyclable") {
    msg = "NONRECYCLABLE\n";
  }

  if (writer) await writer.write(new TextEncoder().encode(msg));
}

/* -------------------- Start / Stop -------------------- */
document.getElementById("startBtn").addEventListener("click", async () => {
  if (!model) await init();
  detecting = true;
  document.getElementById("status").innerText = "🟢 Detecting...";
  lastConfirmedLabel = "";
  lastDetectionTime = 0;
  loop();
  if (writer) await writer.write(new TextEncoder().encode("START\n"));
});

document.getElementById("stopBtn").addEventListener("click", async () => {
  detecting = false;
  document.getElementById("status").innerText = "🟠 Detection stopped";
  if (writer) await writer.write(new TextEncoder().encode("STOP\n"));
});
</script>
</body>
</html>
