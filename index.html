<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>â™»ï¸ RecyGo</title>
<link rel="icon" type="image/png" href="logo.jpg">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-green-50 flex flex-col items-center justify-center min-h-screen text-gray-800">

<h1 class="text-3xl font-bold text-green-700 mb-4">â™»ï¸ RecyGo Smart Recycling</h1>

<div class="flex flex-col items-center space-y-4">

  <button id="connectBtn" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300">ğŸ”Œ Connect Arduino</button>
  <button id="startBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">â–¶ï¸ Start Detection</button>
  <button id="stopBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">â¹ Stop</button>

  <p id="status" class="text-sm text-gray-600">Status: Not connected</p>
  <div id="webcam-container"></div>
  <p id="label" class="text-lg font-medium">Detected: â€”</p>
  <p id="detectStatus" class="text-sm text-gray-600">ğŸ’¤ Waiting...</p>
</div>

<script>
const URL = "https://teachablemachine.withgoogle.com/models/rutvcjBAk/"; // ä½ çš„æ¨¡å‹ç¶²å€
let model, webcam, port, writer;
let detecting = false;
let lastLabel = "", stableCount = 0, lastConfirmedLabel = "";
const STABLE_THRESHOLD = 3;

document.getElementById("connectBtn").addEventListener("click", async ()=>{
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    document.getElementById("status").textContent = "âœ… Arduino Connected";
  } catch (e) {
    alert("Connection failed: " + e);
  }
});

async function init() {
  model = await tmImage.load(URL + "model.json", URL + "metadata.json");
  webcam = new tmImage.Webcam(320, 320, true);
  await webcam.setup();
  await webcam.play();
  document.getElementById("webcam-container").innerHTML = "";
  document.getElementById("webcam-container").appendChild(webcam.canvas);
}

async function loop() {
  webcam.update();
  await predict();
  if (detecting) requestAnimationFrame(loop);
}

async function predict() {
  const prediction = await model.predict(webcam.canvas);
  let best = prediction.reduce((a, b) => a.probability > b.probability ? a : b);
  let className = best.className;
  let conf = best.probability;
  document.getElementById("label").innerText = `Detected: ${className} (${(conf*100).toFixed(1)}%)`;

  if (className === lastLabel && conf > 0.75) stableCount++;
  else { stableCount = 0; lastLabel = className; }

  if (stableCount >= STABLE_THRESHOLD) {
    stableCount = 0;
    handleDetection(className);
  }
}

async function handleDetection(label) {
  if (label === lastConfirmedLabel) return;
  lastConfirmedLabel = label;
  let msg = "";

  if (label === "non-recyclable") {
    msg = "NONRECYCLABLE\n";
    document.getElementById("detectStatus").textContent = "ğŸš« Non-recyclable detected!";
  } else if (label === "plastic") {
    msg = "PLASTIC\n";
    document.getElementById("detectStatus").textContent = "â™»ï¸ Plastic detected!";
  } else if (label === "PET bottle") {
    msg = "PETBOTTLE\n";
    document.getElementById("detectStatus").textContent = "ğŸ¥¤ PET Bottle detected!";
  } else if (label === "metal") {
    msg = "METAL\n";
    document.getElementById("detectStatus").textContent = "ğŸ”© Metal detected!";
  } else {
    document.getElementById("detectStatus").textContent = "âš ï¸ Unknown: " + label;
    return;
  }

  if (writer) {
    await writer.write(new TextEncoder().encode(msg));
  }
}

document.getElementById("startBtn").addEventListener("click", async ()=>{
  if (!model) await init();
  detecting = true;
  document.getElementById("detectStatus").textContent = "ğŸŸ¡ Detecting...";
  loop();
});

document.getElementById("stopBtn").addEventListener("click", async ()=>{
  detecting = false;
  document.getElementById("detectStatus").textContent = "ğŸ’¤ Stopped.";
  if (writer) await writer.write(new TextEncoder().encode("STOP\n"));
});
</script>
</body>
</html>
