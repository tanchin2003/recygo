<!DOCTYPE html>
<html lang="en">
<head>
<!-- ğŸ“± Auto redirect to mobile version -->
<script>
  if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    window.location.href = "mobile.html";
  }
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>â™»ï¸ RecyGo</title>
<link rel="icon" type="image/png" href="logo.jpg">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- âœ… TensorFlow & Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
#webcam-container canvas {
  width: 100% !important;
  height: auto !important;
  max-width: 320px;
  border-radius: 0.5rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
</style>
</head>

<body class="bg-gradient-to-br from-green-50 to-green-100 min-h-screen flex flex-col items-center justify-center text-gray-800">

<!-- ========== Login Section ========== -->
<section id="login-section" class="bg-white p-8 rounded-2xl shadow-xl w-11/12 max-w-md text-center">
  <img src="logo.jpg" alt="RecyGo Logo" class="mx-auto w-24 h-24 rounded-xl mb-3">
  <h1 class="text-3xl font-extrabold text-green-800 mb-2">â™»ï¸ RecyGo</h1>
  <p class="text-green-700 mb-6">Smart Recycling</p>

  <h3 class="text-lg font-semibold mb-3">ğŸ‘©â€ğŸ“ Enter Your 8-digit Student ID</h3>
  <input id="studentId" type="text" placeholder="e.g. 20250123" maxlength="8"
        class="border-2 border-green-300 rounded-lg px-4 py-2 w-72 text-center focus:outline-none focus:border-green-500 transition mb-3" />
  <button id="loginBtn"
          class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition w-72">Login</button>
  <p id="error" class="text-sm text-red-600 mt-2"></p>

  <!-- admin shortcut -->
  <p class="text-xs text-gray-500 mt-4">
    ğŸ”’ <a href="admin.html" class="underline hover:text-green-700">Admin Login</a>
  </p>
</section>

<!-- ========== Main Section ========== -->
<section id="main-section" class="hidden w-full max-w-5xl mx-auto p-6">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Left: Detection Panel -->
    <div class="bg-white p-6 rounded-xl shadow">
      <div class="flex items-center justify-between mb-3">
        <div>
          <p class="text-sm text-gray-500">ğŸ‘¤ Logged in as</p>
          <p id="userId" class="font-medium text-lg text-green-700">â€”</p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500">ğŸ Points</p>
          <p id="points" class="text-2xl font-bold text-green-600">0</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mb-4">
        <button id="connectBtn" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">ğŸ”Œ Connect Arduino</button>
        <button id="startBtn" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">â–¶ï¸ Start Detection</button>
        <button id="stopBtn" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">â¹ Stop</button>
        <button id="logoutBtn" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Logout</button>
      </div>

      <p id="status" class="text-sm text-gray-600 mb-2">Status: Not connected</p>
      <div id="label" class="mb-2 text-base font-medium">Detected: â€”</div>
      <div id="detectStatus" class="mb-4 text-sm text-gray-500">ğŸ’¤ Waiting for detection...</div>

      <div id="webcam-container" class="mx-auto text-center"></div>
    </div>

    <!-- Right: Leaderboard + Chart -->
    <div class="bg-white p-6 rounded-xl shadow space-y-6">
      <div>
        <h2 class="text-xl font-semibold text-green-800 mb-2">ğŸ† Top Recyclers</h2>
        <ul id="leaderboardList" class="space-y-2"></ul>
      </div>

      <div>
        <h2 class="text-xl font-semibold text-green-800 mb-2">ğŸ“Š Recycling Statistics</h2>
        <canvas id="chart" class="w-full max-w-md"></canvas>
      </div>

      <div>
        <h3 class="text-lg font-medium text-green-700 mb-2">ğŸ“ Recent Activity</h3>
        <ul id="recentList" class="text-sm space-y-1 max-h-48 overflow-auto"></ul>
      </div>
    </div>
  </div>
</section>

<script>
/* é˜²å‘†ï¼šç¢ºä¿ tmImage å¯ç”¨ */
if (typeof tmImage === "undefined") var tmImage = window.tmImage;

/* ========== Firebase Setup ========== */
const firebaseConfig = {
  apiKey: "AIzaSyAjWXFfQT_5dBtDZvYFwyj4kGfeWQdcCBU",
  authDomain: "recygo-cd169.firebaseapp.com",
  projectId: "recygo-cd169",
  storageBucket: "recygo-cd169.firebasestorage.app",
  messagingSenderId: "965670715995",
  appId: "1:965670715995:web:b4da5995cb0bd5da8c357e",
  measurementId: "G-9MD9PD9PJL"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ========== Globals ========== */
const URL = "https://teachablemachine.withgoogle.com/models/rutvcjBAk/"; // âœ… æ–°æ¨¡å‹
let model, webcam, port, writer;
let detecting = false;
let rewardPoints = 0;
let currentStudentId = null;
let lastLabel = "", stableCount = 0, lastConfirmedLabel = "";
const STABLE_THRESHOLD = 3;
let pieChart = null;

/* ========== Login ========== */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const id = document.getElementById("studentId").value.trim();
  const errorMsg = document.getElementById("error");
  if (!/^\d{8}$/.test(id)) return errorMsg.textContent = "âš ï¸ Please enter a valid 8-digit ID";

  errorMsg.textContent = "â³ Logging in...";
  currentStudentId = id;
  const docRef = db.collection("students").doc(id);
  const docSnap = await docRef.get();
  if (docSnap.exists) rewardPoints = docSnap.data().points || 0;
  else { await docRef.set({ points: 0 }); rewardPoints = 0; }

  document.getElementById("points").innerText = rewardPoints;
  document.getElementById("userId").innerText = id;
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("main-section").classList.remove("hidden");

  await loadLeaderboard();
  await loadStats();
  await loadRecentRecords();
  errorMsg.textContent = "";
});

/* ========== Arduino Connect ========== */
document.getElementById("connectBtn").addEventListener("click", async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    document.getElementById("status").innerText = "âœ… Arduino Connected";
  } catch (err) {
    alert("âŒ Connection failed: " + err);
    document.getElementById("status").innerText = "âŒ Arduino connection failed";
  }
});

/* ========== AI Init + Detect ========== */
async function init() {
  if (model) return;
  model = await tmImage.load(URL + "model.json", URL + "metadata.json");
  const flip = true;
  webcam = new tmImage.Webcam(320, 320, flip);
  await webcam.setup();
  await webcam.play();
  document.getElementById("webcam-container").innerHTML = "";
  document.getElementById("webcam-container").appendChild(webcam.canvas);
}

async function loop() {
  webcam.update();
  await predict();
  if (detecting) setTimeout(loop, 250);
}

async function predict() {
  const prediction = await model.predict(webcam.canvas);
  let highest = prediction[0];
  for (let p of prediction) if (p.probability > highest.probability) highest = p;

  const className = highest.className.trim().toLowerCase();
  const confidence = highest.probability;
  document.getElementById("label").innerText = `Detected: ${className} (${(confidence * 100).toFixed(1)}%)`;

  if (className === lastLabel && confidence > 0.6) stableCount++;
  else { stableCount = 0; lastLabel = className; }

  if (stableCount >= STABLE_THRESHOLD) {
    stableCount = 0;
    handleStableDetection(className);
  }
}

/* ========== Handle Stable Detection ========== */
async function handleStableDetection(label) {
  if (label === lastConfirmedLabel) return;
  lastConfirmedLabel = label;

  let msg = "", pointsToAdd = 0;
  const ds = document.getElementById("detectStatus");

  // âš™ï¸ æ ¹æ“šä½  Teachable Machine æ¨¡å‹çš„æ¨™ç±¤æ”¹é€™è£¡ï¼ˆè«‹ç¢ºèªæ¨¡å‹ class åç¨±ï¼‰
  switch(label) {
    case "non-recyclable":
      msg = "NONRECYCLABLE\n"; ds.textContent = "ğŸš« Non-recyclable detected!"; ds.style.color = "red"; pointsToAdd = 1; break;
    case "plastic":
      msg = "PLASTIC\n"; ds.textContent = "â™»ï¸ Plastic detected!"; ds.style.color = "blue"; pointsToAdd = 3; break;
    case "pet bottle":
      msg = "PETBOTTLE\n"; ds.textContent = "ğŸ¥¤ PET Bottle detected!"; ds.style.color = "green"; pointsToAdd = 5; break;
    case "metal":
      msg = "METAL\n"; ds.textContent = "ğŸ”© Metal detected!"; ds.style.color = "gray"; pointsToAdd = 4; break;
    default:
      ds.textContent = "âš ï¸ Unknown label: " + label; ds.style.color = "#666"; return;
  }

  rewardPoints += pointsToAdd;
  document.getElementById("points").innerText = rewardPoints;
  if (writer) try { await writer.write(new TextEncoder().encode(msg)); } catch(e){}

  if (currentStudentId) {
    const studentRef = db.collection("students").doc(currentStudentId);
    await studentRef.update({ points: rewardPoints });
    await studentRef.collection("records").add({
      label: label,
      pointsAdded: pointsToAdd,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    await loadLeaderboard();
    await loadStats();
    await loadRecentRecords();
  }
}

/* ========== Buttons ========== */
document.getElementById("startBtn").addEventListener("click", async () => {
  if (!model) await init();
  detecting = true;
  lastConfirmedLabel = "";
  document.getElementById("detectStatus").textContent = "ğŸŸ¡ Detecting...";
  document.getElementById("status").innerText = "ğŸŸ¡ Detection started...";
  if (writer) await writer.write(new TextEncoder().encode("START\n"));
  loop();
});

document.getElementById("stopBtn").addEventListener("click", async () => {
  detecting = false;
  document.getElementById("detectStatus").textContent = "ğŸ’¤ Detection stopped.";
  document.getElementById("status").innerText = "ğŸŸ  Detection stopped";
  if (writer) await writer.write(new TextEncoder().encode("STOP\n"));
});

/* ========== Leaderboard & Stats ========== */
async function loadLeaderboard() {
  const snapshot = await db.collection("students").orderBy("points", "desc").limit(5).get();
  const list = document.getElementById("leaderboardList");
  list.innerHTML = "";
  if (snapshot.empty) {
    list.innerHTML = `<li class="p-2 bg-gray-50 rounded-md">No data yet</li>`;
    return;
  }
  let rank = 1;
  snapshot.forEach(doc => {
    const data = doc.data(); const score = data.points || 0;
    const isMe = (doc.id === currentStudentId);
    list.innerHTML += `
      <li class="flex items-center justify-between p-2 rounded-md ${isMe ? 'bg-green-50 border border-green-100' : 'bg-white'}">
        <div class="text-sm"><span class="font-semibold">#${rank}</span> &nbsp; ${doc.id}</div>
        <div class="text-sm font-medium text-green-700">${score} pts</div>
      </li>`;
    rank++;
  });
}

async function loadStats() {
  const recordsSnap = await db.collectionGroup("records").get();
  let non = 0, plastic = 0, pet = 0, metal = 0;
  recordsSnap.forEach(r => {
    const lb = String(r.data().label).toLowerCase();
    if (lb === "non-recyclable") non++;
    else if (lb === "plastic") plastic++;
    else if (lb === "pet bottle") pet++;
    else if (lb === "metal") metal++;
  });

  const ctx = document.getElementById("chart").getContext('2d');
  const data = {
    labels: ["Non-recyclable", "Plastic", "PET Bottle", "Metal"],
    datasets: [{ data: [non, plastic, pet, metal], backgroundColor: ["#ef4444", "#3b82f6", "#16a34a", "#6b7280"] }]
  };
  if (pieChart) { pieChart.data = data; pieChart.update(); }
  else pieChart = new Chart(ctx, { type: 'pie', data: data, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
}

async function loadRecentRecords() {
  const list = document.getElementById("recentList");
  list.innerHTML = "";
  if (!currentStudentId) return;
  const q = await db.collection("students").doc(currentStudentId)
                .collection("records").orderBy("timestamp", "desc").limit(10).get();
  if (q.empty) { list.innerHTML = `<li class="text-sm text-gray-500">No recent activity</li>`; return; }
  q.forEach(doc => {
    const d = doc.data(); const t = d.timestamp ? d.timestamp.toDate().toLocaleString() : "â€”";
    list.innerHTML += `<li class="text-sm"><span class="font-medium">${d.label}</span> Â· +${d.pointsAdded} pts <span class="text-gray-400">(${t})</span></li>`;
  });
  /* ========== Logout ========== */
document.getElementById("logoutBtn").addEventListener("click", async () => {
  detecting = false; // åœæ­¢æ£€æµ‹
  if (webcam) await webcam.stop();
  if (writer) {
    try { 
      await writer.write(new TextEncoder().encode("STOP\n")); 
      writer.releaseLock();
    } catch(e){}
  }
  if (port) await port.close();

  currentStudentId = null;
  document.getElementById("studentId").value = "";
  document.getElementById("login-section").classList.remove("hidden");
  document.getElementById("main-section").classList.add("hidden");

  document.getElementById("status").innerText = "Status: Not connected";
  document.getElementById("detectStatus").innerText = "ğŸ’¤ Waiting for detection...";
  document.getElementById("points").innerText = "0";
  document.getElementById("userId").innerText = "â€”";
});
}
</script>
</body>
</html>

