<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>â™»ï¸ RecyGo - Smart Recycling</title>
<link rel="icon" type="image/png" href="logo.jpg">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
#webcam-container canvas {
  width: 320px !important;
  border-radius: 10px;
  margin-top: 10px;
}
</style>
</head>
<body class="bg-green-50 min-h-screen flex flex-col items-center">

<!-- Header -->
<header class="p-4 w-full bg-white shadow-md flex items-center justify-between">
  <div class="flex items-center gap-2">
    <img src="logo.jpg" alt="RecyGo Logo" class="w-10 h-10 rounded-md" />
    <h1 class="text-2xl font-bold text-green-700">â™»ï¸ RecyGo</h1>
  </div>
  <nav class="text-sm text-green-700">
    <a href="mobile.html" class="hover:underline mr-4">Mobile</a>
    <a href="admin.html" class="hover:underline">Admin</a>
  </nav>
</header>

<!-- Login -->
<section id="login-section" class="mt-20 text-center">
  <h3 class="text-lg font-medium text-green-700 mb-2">ğŸ‘©â€ğŸ“ Enter Your 8-digit Student ID</h3>
  <input id="studentId" type="text" maxlength="8" placeholder="e.g. 20250123"
         class="border border-green-400 rounded-lg px-3 py-2 w-64 text-center mb-2">
  <button id="loginBtn" class="bg-green-600 text-white px-5 py-2 rounded-lg">Login / Register</button>
  <p id="error" class="text-red-500 text-sm mt-2"></p>
</section>

<!-- Main -->
<section id="main-section" class="hidden mt-6 w-full max-w-5xl mx-auto">
  <div class="flex justify-between items-center px-6">
    <div>
      <p class="text-sm text-gray-600">ğŸ‘¤ Logged in as: <span id="userId" class="font-semibold text-green-700"></span></p>
      <p class="text-lg font-semibold">ğŸ Points: <span id="points" class="text-green-600 text-xl">0</span></p>
    </div>
    <button id="logoutBtn" class="bg-gray-200 px-4 py-1 rounded-lg hover:bg-gray-300">Logout</button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
    <!-- AI Detection -->
    <div class="bg-white rounded-xl shadow p-4 text-center">
      <h2 class="text-lg font-semibold text-green-800 mb-2">ğŸ§  AI Detection</h2>
      <div id="webcam-container"></div>
      <p id="label" class="mt-2 text-gray-600">Detected: â€”</p>
      <p id="detectStatus" class="mt-1 font-medium text-gray-500">ğŸ’¤ Waiting for detection...</p>
      <div class="mt-4 space-x-3">
        <button id="connectBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg">ğŸ”Œ Connect Arduino</button>
        <button id="startBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg">â–¶ï¸ Start</button>
        <button id="stopBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg">â¹ Stop</button>
      </div>
      <p id="status" class="mt-3 text-sm text-gray-600">Status: Not connected</p>
    </div>

    <!-- Leaderboard & Chart -->
    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold text-green-800 mb-3">ğŸ† Leaderboard</h2>
      <ul id="leaderboardList" class="space-y-1 text-sm mb-4"></ul>
      <h2 class="text-lg font-semibold text-green-800 mb-2">ğŸ“Š Recycling Stats</h2>
      <canvas id="chart" height="180"></canvas>
    </div>
  </div>
</section>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAjWXFfQT_5dBtDZvYFwyj4kGfeWQdcCBU",
  authDomain: "recygo-cd169.firebaseapp.com",
  projectId: "recygo-cd169",
  storageBucket: "recygo-cd169.firebasestorage.app",
  messagingSenderId: "965670715995",
  appId: "1:965670715995:web:b4da5995cb0bd5da8c357e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let model, webcam, writer, port, detecting=false, rewardPoints=0;
let currentStudentId=null, lastLabel="", stableCount=0, lastConfirmedLabel="";
const URL = "https://teachablemachine.withgoogle.com/models/YSmHvTp9K/";
const STABLE_THRESHOLD = 3;

/* Login */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const id = document.getElementById("studentId").value.trim();
  const error = document.getElementById("error");
  if (!/^\d{8}$/.test(id)) { error.textContent = "âš ï¸ Invalid ID"; return; }
  error.textContent = "â³ Logging in...";
  const ref = db.collection("students").doc(id);
  const snap = await ref.get();
  rewardPoints = snap.exists ? snap.data().points || 0 : 0;
  if (!snap.exists) await ref.set({ points: 0 });
  document.getElementById("points").innerText = rewardPoints;
  document.getElementById("userId").innerText = id;
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("main-section").classList.remove("hidden");
  loadLeaderboard(); loadChart();
  currentStudentId = id;
});

/* Logout */
document.getElementById("logoutBtn").onclick = () => location.reload();

/* Arduino Connect */
document.getElementById("connectBtn").addEventListener("click", async () => {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    document.getElementById("status").innerText = "âœ… Arduino Connected";
  } catch (err) { alert("âŒ Connection failed: " + err); }
});

/* Teachable Machine */
async function init() {
  model = await tmImage.load(URL + "model.json", URL + "metadata.json");
  webcam = new tmImage.Webcam(320, 320, true);
  await webcam.setup();
  await webcam.play();
  document.getElementById("webcam-container").innerHTML = "";
  document.getElementById("webcam-container").appendChild(webcam.canvas);
}

/* Detection */
document.getElementById("startBtn").addEventListener("click", async () => {
  if (!model) await init();
  detecting = true;
  detectLoop();
});
document.getElementById("stopBtn").addEventListener("click", () => detecting=false);

async function detectLoop() {
  webcam.update();
  await predict();
  if (detecting) requestAnimationFrame(detectLoop);
}

async function predict() {
  const preds = await model.predict(webcam.canvas);
  let top = preds.reduce((a,b)=> a.probability > b.probability ? a : b);
  const label = top.className.toLowerCase();
  const conf = top.probability;
  document.getElementById("label").innerText = `Detected: ${label} (${(conf*100).toFixed(1)}%)`;

  if (label === lastLabel && conf>0.6) stableCount++; else { stableCount=0; lastLabel=label; }
  if (stableCount>=STABLE_THRESHOLD) { stableCount=0; handleDetection(label); }
}

async function handleDetection(label) {
  if (label === lastConfirmedLabel) return;
  lastConfirmedLabel = label;
  const ds = document.getElementById("detectStatus");
  let add=0;
  if (label==="recyclable"){ ds.textContent="âœ… Recyclable detected!"; ds.style.color="green"; add=5; }
  else if (["non-recyclable","nonrecyclable"].includes(label)){ ds.textContent="ğŸš« Non-recyclable detected!"; ds.style.color="red"; add=1; }
  else return;

  rewardPoints+=add;
  document.getElementById("points").innerText=rewardPoints;
  await db.collection("students").doc(currentStudentId).update({points:rewardPoints});
  await db.collection("students").doc(currentStudentId).collection("records").add({
    label, pointsAdded:add, timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  loadLeaderboard(); loadChart();
  if(writer) await writer.write(new TextEncoder().encode(label.toUpperCase()+"\n"));
}

/* Leaderboard */
async function loadLeaderboard(){
  const list=document.getElementById("leaderboardList");
  list.innerHTML="";
  const snap=await db.collection("students").orderBy("points","desc").limit(10).get();
  let rank=1;
  snap.forEach(doc=>{
    list.innerHTML+=`<li class="flex justify-between border-b text-sm py-1 ${doc.id===currentStudentId?'bg-green-50':''}">
      <span>#${rank} ${doc.id}</span><span>${doc.data().points||0} pts</span></li>`;
    rank++;
  });
}

/* Chart */
async function loadChart(){
  const ref=db.collection("students").doc(currentStudentId).collection("records");
  const snap=await ref.orderBy("timestamp","desc").limit(20).get();
  let recyclable=0,non=0;
  snap.forEach(d=>{const v=d.data().label;if(v.includes("recyclable"))recyclable++;else non++;});
  const ctx=document.getElementById("chart").getContext("2d");
  new Chart(ctx,{type:"doughnut",data:{
    labels:["Recyclable","Non-Recyclable"],
    datasets:[{data:[recyclable,non],backgroundColor:["#16a34a","#f87171"]}]
  }});
}
</script>
</body>
</html>


