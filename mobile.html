<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“± RecyGo Mobile</title>
<link rel="icon" type="image/png" href="logo.jpg">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body class="bg-gradient-to-br from-green-50 to-green-100 min-h-screen flex flex-col items-center justify-center text-gray-800">

<!-- ========== Mobile Login ========== -->
<section id="login-section" class="bg-white p-8 rounded-2xl shadow-xl w-11/12 max-w-sm text-center">
  <img src="logo.jpg" alt="RecyGo Logo" class="mx-auto w-20 h-20 rounded-xl mb-3">
  <h1 class="text-2xl font-extrabold text-green-800 mb-2">â™»ï¸ RecyGo</h1>
  <p class="text-green-700 mb-5">Check your recycling score</p>

  <h3 class="text-base font-semibold mb-3">ğŸ‘©â€ğŸ“ Enter Your 8-digit Student ID</h3>
  <input id="studentId" type="text" maxlength="8" placeholder="e.g. 20250123"
         class="border-2 border-green-300 rounded-lg px-4 py-2 w-64 text-center focus:border-green-500 mb-3" />
  <button id="loginBtn"
          class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition w-64">Login</button>
  <p id="error" class="text-sm text-red-600 mt-2"></p>
</section>

<!-- ========== Main Section ========== -->
<section id="main-section" class="hidden w-full max-w-md mx-auto p-4">
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <p class="text-sm text-gray-500">ğŸ‘¤ Student ID</p>
        <p id="userId" class="font-medium text-green-700 text-lg">â€”</p>
      </div>
      <div class="text-right">
        <p class="text-sm text-gray-500">ğŸ Points</p>
        <p id="points" class="text-2xl font-bold text-green-600">0</p>
      </div>
    </div>

    <h2 class="text-lg font-semibold text-green-800 mt-4 mb-2">ğŸ† Leaderboard</h2>
    <ul id="leaderboardList" class="space-y-1 mb-4"></ul>

    <h2 class="text-lg font-semibold text-green-800 mb-2">ğŸ“Š Recycling Statistics</h2>
    <canvas id="chart" class="w-full h-48"></canvas>

    <button id="logoutBtn"
            class="mt-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 w-full">Logout</button>
  </div>
</section>

<script>
/* Firebase Setup */
const firebaseConfig = {
  apiKey: "AIzaSyAjWXFfQT_5dBtDZvYFwyj4kGfeWQdcCBU",
  authDomain: "recygo-cd169.firebaseapp.com",
  projectId: "recygo-cd169",
  storageBucket: "recygo-cd169.firebasestorage.app",
  messagingSenderId: "965670715995",
  appId: "1:965670715995:web:b4da5995cb0bd5da8c357e",
  measurementId: "G-9MD9PD9PJL"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentStudentId = null;
let pieChart = null;

/* Login */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const id = document.getElementById("studentId").value.trim();
  const error = document.getElementById("error");
  if (!/^\d{8}$/.test(id)) { error.textContent = "âš ï¸ Invalid ID"; return; }

  error.textContent = "â³ Logging in...";
  const ref = db.collection("students").doc(id);
  const snap = await ref.get();

  let points = 0;
  if (snap.exists) points = snap.data().points || 0;
  else await ref.set({ points: 0 });

  currentStudentId = id;
  document.getElementById("userId").textContent = id;
  document.getElementById("points").textContent = points;

  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("main-section").classList.remove("hidden");
  error.textContent = "";

  await loadLeaderboard();
  await loadStats();
});

/* Logout */
document.getElementById("logoutBtn").addEventListener("click", () => location.reload());

/* Leaderboard */
async function loadLeaderboard() {
  const list = document.getElementById("leaderboardList");
  list.innerHTML = "";
  const snap = await db.collection("students").orderBy("points", "desc").limit(5).get();
  let rank = 1;
  snap.forEach(doc => {
    const data = doc.data();
    const isMe = (doc.id === currentStudentId);
    list.innerHTML += `
      <li class="flex justify-between p-2 rounded-md ${isMe ? 'bg-green-50 border border-green-200' : 'bg-white'}">
        <span class="text-sm">#${rank} ${doc.id}</span>
        <span class="text-sm font-medium text-green-700">${data.points || 0} pts</span>
      </li>`;
    rank++;
  });
}

/* Chart */
async function loadStats() {
  const records = await db.collectionGroup("records").get();
  let non=0, plastic=0, pet=0, metal=0;
  records.forEach(r => {
    const lb = String(r.data().label).toLowerCase();
    if (lb==="non-recyclable") non++;
    else if (lb==="plastic") plastic++;
    else if (lb==="pet bottle") pet++;
    else if (lb==="metal") metal++;
  });

  const ctx=document.getElementById("chart").getContext("2d");
  const data={
    labels:["Non-recyclable","Plastic","PET Bottle","Metal"],
    datasets:[{data:[non,plastic,pet,metal],
      backgroundColor:["#ef4444","#3b82f6","#16a34a","#6b7280"]}]
  };
  if (pieChart) { pieChart.data=data; pieChart.update(); }
  else pieChart=new Chart(ctx,{type:"pie",data:data,options:{plugins:{legend:{position:"bottom"}}}});
}
</script>

</body>
</html>
